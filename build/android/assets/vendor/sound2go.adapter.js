const FOLDER="MP3Cache";if(Ti.Filesystem.isExternalStoragePresent())var DEPOT=Ti.Filesystem.externalStorageDirectory;else var DEPOT=Ti.Filesystem.applicationDataDirectory;var folder=Ti.Filesystem.getFile(DEPOT,FOLDER);folder.exists()||folder.createDirectory();var Model=new(require("adapter/model")),Adapter=function(e){var t=e;this.eventhandlers={};var n=this;return n.mp3s=[],t&&Array.isArray(t)&&t.forEach(function(e){var t=Ti.Filesystem.getFile(DEPOT,FOLDER,Ti.Utils.md5HexDigest(e)+".wt3");n.mp3s.push({url:e,file:t,cached:t.exists()?!0:!1})}),this};Adapter.prototype={getModels:function(){return this.models},getWT3:function(e){var t=this,n=t.mp3s.filter(function(n,a){return t.mp3s[a].url==e?!0:!1});return n?n[0].cached?n[0].file.nativePath:n[0].url:e},areCached:function(){var e=this.models.filter(function(e){return Ti.Filesystem.getFile(DEPOT,FOLDER,Ti.Utils.md5HexDigest(e.url)+".wt3").exists()});return e.length==this.models.length?!0:!1},toggleAllURLs:function(){1==this.areCached()?(console.log("TRUE"),this.uncacheAllURLs()):this.cacheAllURLs()},cacheAllURLs:function(){function e(e,t){var n=Ti.Network.createHTTPClient({onload:function(){console.log(this.status),200==this.status&&t(this.responseData)}});console.log("caching of "+e.url),n.open("GET",e.url,!0),n.send()}function t(a){e(n.mp3s[a],function(e){if(n.mp3s[a].file.write(e),n.mp3s[a].cached=!0,a++,a<n.mp3s.length){console.log("NEXT model");var r=a/n.mp3s.length;n.fireEvent("onprogress",{progress:r}),t(a)}else n.fireEvent("oncompleted",{cached:!0})})}var n=this;n.fireEvent("onprogress",{progress:.1});var a=0;t(a)},uncacheAllURLs:function(){console.log("Info try to remove all caches"),this.models.forEach(function(e){e.file.exists()&&e.file.deleteFile(),e.cached=!1}),this.fireEvent("oncompleted",{cached:!1})},fireEvent:function(e,t){if(this.eventhandlers[e])for(var n=0;n<this.eventhandlers[e].length;n++)this.eventhandlers[e][n].call(this,t)},addEventListener:function(e,t){this.eventhandlers||(this.eventhandlers={}),this.eventhandlers[e]||(this.eventhandlers[e]=[]),this.eventhandlers[e].push(t)},removeEventListener:function(e,t){if(this.eventhandlers[e]){var n=this.eventhandlers[e].filter(function(e){return e!=t});this.eventhandlers[e]=n}}},module.exports=Adapter;